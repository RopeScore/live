service cloud.firestore {
  match /databases/{database}/documents {
    function superAdmin() {
      return get(/databases/$(database)/documents/globconfig/admins)[request.auth.uid] != null
    }
    match /live/federations/{federation} {
      function isAdmin() {
        return superAdmin() || get(/databases/$(database)/documents/live/federations/$(federation)/config).data.admins[request.auth.uid] != null
      }
      match /categories/{document=**} {
        function isPublic() {
          return get(/databases/$(database)/documents/live/federations/$(federation)/categories/$(request.path[7])/config).data.visible == true
        }
        allow read: if isAdmin() || isPublic();
        allow write: if isAdmin();
      }
      match /config {
        allow read: if isAdmin();
        allow read, write: if isAdmin() && request.resource.data.apikey == resource.data.apikey;
      }
    }
  }
}
